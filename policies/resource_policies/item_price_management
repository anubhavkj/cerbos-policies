apiVersion: api.cerbos.dev/v1
resourcePolicy:
  version: default
  resource: ItemPriceManagement

  rules:
    # READ
    - actions: ["price_read"]
      effect: EFFECT_ALLOW
      roles:
        - user
        - inventory_control_specialist
        - warehouse_manager
        - supply_chain_manager
        - inventory_admin
      condition:
        match:
          expr: |
            request.principal.roles.exists(r,
              r in (
                (
                  (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantA"
                )
                ? ["user","inventory_control_specialist","warehouse_manager","supply_chain_manager","inventory_admin"]
                :
                (
                  (
                    (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantB"
                  )
                  ? ["user","inventory_control_specialist","warehouse_manager","supply_chain_manager","inventory_admin"]
                  : []
                )
              )
            )

    # CREATE  (note: ICS allowed in tenantA, not in tenantB)
    - actions: ["price_create"]
      effect: EFFECT_ALLOW
      roles:
        - user
        - inventory_control_specialist
        - warehouse_manager
        - supply_chain_manager
        - inventory_admin
      condition:
        match:
          expr: |
            request.principal.roles.exists(r,
              r in (
                (
                  (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantA"
                )
                ? ["inventory_control_specialist","warehouse_manager","supply_chain_manager","inventory_admin"]
                :
                (
                  (
                    (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantB"
                  )
                  ? ["warehouse_manager","supply_chain_manager","inventory_admin"]
                  : []
                )
              )
            )

    # UPDATE
    - actions: ["price_update"]
      effect: EFFECT_ALLOW
      roles:
        - user
        - inventory_control_specialist
        - warehouse_manager
        - supply_chain_manager
        - inventory_admin
      condition:
        match:
          expr: |
            request.principal.roles.exists(r,
              r in (
                (
                  (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantA"
                )
                ? ["warehouse_manager","supply_chain_manager","inventory_admin"]
                :
                (
                  (
                    (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantB"
                  )
                  ? ["warehouse_manager","supply_chain_manager","inventory_admin"]
                  : []
                )
              )
            )

    # DELETE
    - actions: ["price_delete"]
      effect: EFFECT_ALLOW
      roles:
        - user
        - inventory_control_specialist
        - warehouse_manager
        - supply_chain_manager
        - inventory_admin
      condition:
        match:
          expr: |
            request.principal.roles.exists(r,
              r in (
                (
                  (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantA"
                )
                ? ["supply_chain_manager"]
                :
                (
                  (
                    (request.resource.attr.tenant != "" ? request.resource.attr.tenant : request.principal.attr.active_tenant) == "tenantB"
                  )
                  ? ["supply_chain_manager"]
                  : []
                )
              )
            )

