apiVersion: api.cerbos.dev/v1
derivedRoles:
  name: role_hierarchy_scoped
  definitions:
    - name: same_tenant
      condition:
        match:
          expr: request.principal.attr.tenant == request.resource.attr.tenant

    - name: same_region
      condition:
        match:
          expr: request.principal.attr.region == request.resource.attr.region

    - name: within_variance_limit
      condition:
        match:
          expr: request.resource.attr.variance <= request.resource.attr.threshold

    - name: exceeds_variance_limit
      condition:
        match:
          expr: request.resource.attr.variance > request.resource.attr.threshold

    - name: user_role
      parentRoles: ["user"]
      condition:
        match:
          expr: derivedRoles.same_tenant

    - name: specialist_role
      parentRoles: ["inventory_control_specialist"]
      condition:
        match:
          expr: derivedRoles.same_tenant

    - name: manager_role
      parentRoles: ["warehouse_manager"]
      condition:
        match:
          expr: derivedRoles.same_tenant

    - name: scm_role
      parentRoles: ["supply_chain_manager"]
      condition:
        match:
          expr: derivedRoles.same_tenant && derivedRoles.same_region

    - name: admin_role
      parentRoles: ["inventory_admin"]
      condition:
        match:
          expr: derivedRoles.same_tenant
